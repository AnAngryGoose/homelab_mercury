services:
  # --- 1. NGINX PROXY MANAGER (The Middleman) ---
  # Connected to BOTH networks so it can bridge the gap.
  npm:
    image: jc21/nginx-proxy-manager:latest
    container_name: npm
    restart: unless-stopped
    ports:
      - "80:80"     # HTTP
      - "81:81"     # Admin UI
      - "443:443"   # HTTPS
    environment:
      DB_SQLITE_FILE: "/data/database.sqlite"
    volumes:
      - ./npm/data:/data
      - ./npm/letsencrypt:/etc/letsencrypt
    networks:
      - ingress_net   # To talk to Cloudflare
      - internal_net  # To talk to FileBrowser

  # --- 2. FILEBROWSER QUANTUM (The Hidden App) ---
  # Only on internal_net. Cloudflare cannot reach this directly.
  filebrowser:
    image: gtstef/filebrowser:beta
    container_name: filebrowser-quantum
    restart: unless-stopped
    user: ${PUID}:${PGID}
    networks:
      - internal_net  # <-- ISOLATED - TO TALK TO NPM ONLY
    environment:
      - FILEBROWSER_CONFIG=/config/config.yaml
      - FILEBROWSER_ADMIN_PASSWORD=${FB_ADMIN_PASS}
    volumes:
      # Config & Database
      - ${PATH_CONFIG}:/config
      - ${PATH_DATA}:/data/
      # Data Sources
      - ${PATH_SOURCE_MEDIA}:/media
      - ${PATH_SOURCE_USERS}:/users
    deploy:
      resources:
        limits:
          cpus: '0.50'   # Max 50% of one core
          memory: 512M   # Max 512MB RAM

  # --- 3. CLOUDFLARE TUNNEL (The Front Door) ---
  # Only on ingress_net. It can only talk to NPM.
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: always
    networks:
      - ingress_net   # <-- ISOLATED TO TALK TO NPM ONLY
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    command: tunnel run

# --- NETWORK DEFINITIONS ---
networks:
  ingress_net:
    driver: bridge
  internal_net:
    driver: bridge